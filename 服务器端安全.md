# 服务器端安全

## 1.通过路径遍历读取任意文件

假如用户用一个用于读取文件的标签：`<img src="/loadImage?filename=218.png">`，url地址`/loadImage`接受一个filename参数，代表文件路径，访问`218.png`是从`/var/www/images/218.png`读取的文件，如果此应用程序未实施针对路径遍历攻击的防御措施。则攻击者可以请求以下 URL 来从服务器的文件系统中检索文件`/etc/passwd`：`/loadImage?filename=../../../etc/passwd`，

## 2.访问控制

访问控制是对谁或什么有权执行操作或访问资源进行限制。在 Web 应用程序环境中，访问控制依赖于身份验证和会话管理：

- **身份验证**可确认用户确实是其所说的身份。
- **会话管理**识别同一用户发出了哪些后续 HTTP 请求。
- **访问控制**决定用户是否被允许执行他们试图执行的操作。

访问控制失效很常见，而且往往会带来严重的安全漏洞。访问控制的设计和管理是一个复杂而动态的问题，需要将业务、组织和法律约束应用于技术实施。访问控制设计决策必须由人来做出，因此出现错误的可能性很高。

### 2.1垂直特权升级

如果用户可以访问他们无权访问的功能，则这就是垂直特权升级。例如，如果非管理员用户可以访问管理页面并删除用户帐户，则这就是垂直特权升级。

最基本的垂直特权提升发生在应用程序未对敏感功能实施任何保护的情况下。例如，管理功能可能链接到管理员的欢迎页面，但未链接到用户的欢迎页面。但是，用户可能能够通过浏览相关管理 URL 来访问管理功能。

**2.1.1** 例如，某个网站可能在以下 URL 上托管敏感功能：

```
https://insecure-website.com/admin
```

任何用户都可以访问该 URL，而不仅仅是拥有用户界面中功能链接的管理用户。在某些情况下，管理 URL 可能会在其他位置泄露，例如文件`robots.txt`：

```
https://insecure-website.com/robots.txt
```

即使 URL 未在任何地方公开，攻击者也可能能够使用单词列表来强行获取敏感功能的位置。

**2.1.2** 在某些情况下，敏感功能可以通过为其提供不太可预测的 URL 来隐藏。这就是所谓的“模糊性安全”的一个例子。但是，隐藏敏感功能并不能提供有效的访问控制，因为用户可能会通过多种方式发现模糊的 URL。

想象一下在以下 URL 上托管管理功能的应用程序：

```
https://insecure-website.com/administrator-panel-yb556
```

攻击者可能无法直接猜出这一点。但是，应用程序仍可能将 URL 泄露给用户。该 URL 可能会在根据用户角色构建用户界面的 JavaScript 中泄露：

```js
<script>
    var isAdmin = false;
    if (isAdmin) {
        var adminPanelTag = document.createElement('a');
        adminPanelTag.setAttribute('href', 'https://insecure-website.com/administrator-panel-yb556');
        adminPanelTag.innerText = 'Admin panel';
        }
</script>
```

如果用户是管理员用户，此脚本会向用户的 UI 添加链接。但是，无论用户的角色是什么，包含 URL 的脚本对所有用户都是可见的。

**2.1.3** 基于参数的访问控制方法

某些应用程序会在用户登录时确定其访问权限或角色，然后将此信息存储在用户可控制的位置。这可能是：

- 一个隐藏字段。
- 一个cookie。
- 预设的查询字符串参数。

应用程序根据提交的值做出访问控制决策。例如：

```
https://insecure-website.com/login/home.jsp?admin=true 
https://insecure-website.com/login/home.jsp?role=1
```

这种方法不安全，因为用户可以修改他们未被授权的值并访问功能，例如管理功能。



### 2.2 水平特权升级

如果用户能够访问属于其他用户的资源，而不是他们自己的同类资源，则会发生横向特权升级。例如，如果一名员工可以访问其他员工的记录以及自己的记录，那么这就是横向特权升级。

水平特权提升攻击可能使用与垂直特权提升类似的漏洞利用方法。例如，用户可能使用以下 URL 访问自己的帐户页面：

```
https://insecure-website.com/myaccount?id=123
```

如果攻击者将`id`参数值修改为其他用户的值，他们可能会访问其他用户的帐户页面以及相关数据和功能。

#### 笔记

这是一个不安全的直接对象引用 (IDOR) 漏洞的示例。此类漏洞出现在用户控制器参数值用于直接访问资源或功能时。

在某些应用程序中，可利用参数没有可预测的值。例如，应用程序可能使用全局唯一标识符 (GUID) 来识别用户，而不是使用递增数字。这可以防止攻击者猜测或预测其他用户的标识符。但是，属于其他用户的 GUID 可能会在应用程序中引用用户的其他地方泄露，例如用户消息或评论。

### 2.3 从水平到垂直的权限提升

通常，水平特权升级攻击可以通过攻击具有更高特权的用户转变为垂直特权升级。例如，水平升级可能允许攻击者重置或获取属于其他用户的密码。如果攻击者瞄准管理员用户并攻击其帐户，那么他们就可以获得管理员访问权限，从而执行垂直特权升级。

攻击者可能能够使用上面描述的水平特权提升的参数篡改技术来访问另一个用户的帐户页面：

```
https://insecure-website.com/myaccount?id=456
```

如果目标用户是应用程序管理员，那么攻击者将获得对管理帐户页面的访问权限。此页面可能会泄露管理员的密码或提供更改密码的方法，或者可能提供对特权功能的直接访问权限。

## 3.身份验证漏洞

从概念上来说，身份验证漏洞很容易理解。然而，由于身份验证与安全性之间存在明确的关系，因此这些漏洞通常非常严重。

身份验证漏洞可让攻击者获取敏感数据和功能的访问权限。它们还会为进一步的攻击提供额外的攻击面。因此，了解如何识别和利用身份验证漏洞以及如何绕过常见的保护措施非常重要。

在本节中，我们将解释：

- 网站使用的最常见的身份验证机制。
- 这些机制中存在的潜在漏洞。
- 不同身份验证机制中存在固有的漏洞。
- 由于实施不当而引入的典型漏洞。
- 如何使您的身份验证机制尽可能的强大。

### 身份验证和授权有什么区别？

身份验证是验证用户是否是其所声称的身份的过程。授权涉及验证用户是否被允许执行某项操作。

例如，身份验证可以确定尝试使用用户名`Carlos123`访问网站的人是否确实是创建该帐户的人。

一旦`Carlos123`通过身份验证，他们的权限将决定他们有权做什么。例如，他们可能被授权访问其他用户的个人信息，或执行删除其他用户帐户等操作。

### 暴力攻击

暴力攻击是指攻击者使用反复试验的系统来猜测有效的用户凭据。这些攻击通常使用用户名和密码的单词表自动执行。自动执行此过程（尤其是使用专用工具）可能使攻击者能够高速进行大量登录尝试。

暴力破解并不总是完全随机猜测用户名和密码。通过使用基本逻辑或公开知识，攻击者可以微调暴力破解攻击，以做出更有根据的猜测。这大大提高了此类攻击的效率。如果网站没有实施足够的暴力破解保护，那么依靠基于密码的登录作为唯一用户身份验证方法的网站可能会非常脆弱。

### 暴力破解用户名

如果用户名符合可识别的模式，例如电子邮件地址，则特别容易被猜到。例如，企业登录名的格式非常常见`firstname.lastname@somecompany.com`。但是，即使没有明显的模式，有时甚至高权限帐户也会使用可预测的用户名创建，例如`admin`或`administrator`。

在审计期间，请检查网站是否公开披露了潜在的用户名。例如，您是否能够在不登录的情况下访问用户个人资料？即使个人资料的实际内容是隐藏的，个人资料中使用的名称有时也与登录用户名相同。您还应该检查 HTTP 响应，看看是否有任何电子邮件地址被泄露。有时，响应包含高权限用户的电子邮件地址，例如管理员或 IT 支持人员

### 暴力破解密码

密码同样可以被暴力破解，破解难度取决于密码的强度。许多网站采用某种形式的密码策略，强制用户创建高熵密码，理论上，这些密码更难通过暴力破解。这通常涉及强制使用以下密码：

- 最少字符数
- 大小写字母混合
- 至少一个特殊字符

然而，尽管高熵密码很难被计算机单独破解，但我们可以利用人类行为的基本知识来利用用户在不知不觉中引入该系统的漏洞。用户通常不会使用随机字符组合来创建强密码，而是使用他们能记住的密码，并尝试将其强行纳入密码策略。例如，如果`mypassword`不允许，用户可能会尝试使用`Mypassword1!`或`Myp4$$w0rd`之类的方法。

在政策要求用户定期更改密码的情况下，用户通常也会对其首选密码进行轻微的、可预测的更改。例如，`Mypassword1!`变为`Mypassword1?`或`Mypassword2!.`

对可能的凭证和可预测模式的了解意味着暴力攻击通常比简单地遍历所有可能的字符组合更加复杂，因此也更加有效。

### 用户名枚举

用户名枚举是指攻击者能够观察网站行为的变化以确定给定的用户名是否有效。

用户名枚举通常发生在登录页面上，例如，当您输入有效的用户名但密码不正确时，或者在注册表单上输入已被占用的用户名时。这大大减少了暴力登录所需的时间和精力，因为攻击者能够快速生成有效用户名的候选名单。

### 绕过双因素身份验证

有时，双因素身份验证的实施存在缺陷，以至于可以完全绕过。

如果首先提示用户输入密码，然后在单独的页面上提示用户输入验证码，则用户在输入验证码之前实际上处于“登录”状态。在这种情况下，值得测试一下，看看完成第一个身份验证步骤后是否可以直接跳转到“仅登录”页面。有时，您会发现网站在加载页面之前实际上并没有检查您是否完成了第二步。



## 4.SSRF攻击

### 什么是 SSRF？

服务器端请求伪造是一种网络安全漏洞，允许攻击者导致服务器端应用程序向非预期位置发出请求。

在典型的 SSRF 攻击中，攻击者可能会导致服务器连接到组织基础设施内仅供内部使用的服务。在其他情况下，他们可能会强制服务器连接到任意外部系统。这可能会泄露敏感数据，例如授权凭据。

### 针对服务器的 SSRF 攻击

在针对服务器的 SSRF 攻击中，攻击者会让应用程序通过其环回网络接口向托管该应用程序的服务器发出 HTTP 请求。这通常涉及提供一个带有主机名的 URL，例如`127.0.0.1`（指向环回适配器的保留 IP 地址）或`localhost`（同一适配器的常用名称）。

例如，假设有一个购物应用程序，它允许用户查看某个商店中某件商品是否有货。为了提供库存信息，该应用程序必须查询各种后端 REST API。它通过前端 HTTP 请求将 URL 传递到相关的后端 API 端点来实现这一点。当用户查看某件商品的库存状态时，他们的浏览器会发出以下请求：

```
POST /product/stock HTTP/1.0 Content-Type: application/x-www-form-urlencoded Content-Length: 118 stockApi=http://stock.weliketoshop.net:8080/product/stock/check%3FproductId%3D6%26storeId%3D1
```

这会导致服务器向指定的 URL 发出请求，检索库存状态，并将其返回给用户。

在此示例中，攻击者可以修改请求以指定服务器本地的 URL：

```
POST /product/stock HTTP/1.0 Content-Type: application/x-www-form-urlencoded Content-Length: 118 stockApi=http://localhost/admin
```

服务器获取 URL 的内容`/admin`并将其返回给用户。

攻击者可以访问该`/admin`URL，但管理功能通常只有经过身份验证的用户才能访问。这意味着攻击者不会看到任何有趣的东西。但是，如果对该`/admin`URL 的请求来自本地计算机，则正常的访问控制将被绕过。应用程序授予对管理功能的完全访问权限，因为该请求似乎来自受信任的位置。

为什么应用程序会以这种方式运行，并隐式信任来自本地计算机的请求？ 这可能由多种原因引起：

- 访问控制检查可能在位于应用服务器前面的不同组件中实现。当重新连接到服务器时，检查将被绕过。
- 出于灾难恢复目的，应用程序可能允许来自本地计算机的任何用户无需登录即可进行管理访问。这为管理员提供了一种在丢失凭据时恢复系统的方法。这假设只有完全受信任的用户才能直接从服务器访问。
- 管理界面可能会监听与主应用程序不同的端口号，并且用户可能无法直接访问。

这种信任关系，其中来自本地机器的请求与普通请求的处理方式不同，通常会使 SSRF 成为一个严重的漏洞。

### 针对其他后端系统的 SSRF 攻击

在某些情况下，应用服务器能够与用户无法直接访问的后端系统进行交互。这些系统通常具有不可路由的私有 IP 地址。后端系统通常受网络拓扑保护，因此它们的安全状况通常较弱。在许多情况下，内部后端系统包含敏感功能，任何能够与系统交互的人都可以在未经身份验证的情况下访问这些功能。

在上面的例子中，假设后端 URL 处有一个管理界面` https://192.168.0.68/admin`。攻击者可以提交以下请求来利用 SSRF 漏洞，并访问管理界面：

```
POST /product/stock HTTP/1.0 Content-Type: application/x-www-form-urlencoded Content-Length: 118 stockApi=http://192.168.0.68/admin
```

## 5.文件上传漏洞

### 什么是文件上传漏洞？

文件上传漏洞是指 Web 服务器允许用户将文件上传到其文件系统，而没有充分验证文件的名称、类型、内容或大小等信息。如果未能正确执行这些限制，就意味着即使是基本的图像上传功能也可用于上传任意且具有潜在危险的文件。这甚至可能包括允许远程代码执行的服务器端脚本文件。

在某些情况下，上传文件的行为本身就足以造成损害。其他攻击可能涉及对文件的后续 HTTP 请求，通常是为了触发服务器执行该文件。

### 文件上传漏洞是如何产生的？

鉴于这些相当明显的危险，很少有网站对用户上传的文件没有任何限制。更常见的情况是，开发人员实施他们认为强大的验证，但这种验证要么天生就有缺陷，要么很容易被绕过。

例如，他们可能会尝试将危险的文件类型列入黑名单，但在检查文件扩展名时却没有考虑到解析差异。与任何黑名单一样，也很容易意外忽略可能仍然很危险的较不显眼的文件类型。

在其他情况下，网站可能会尝试通过验证属性来检查文件类型，而攻击者可以使用 Burp Proxy 或 Repeater 等工具轻松操纵这些属性。

最终，即使是强大的验证措施也可能会在构成网站的主机和目录网络中不一致地应用，从而导致可以利用的差异。

### 利用不受限制的文件上传来部署 Web Shell

从安全角度来看，最糟糕的情况是网站允许您上传服务器端脚本（例如 PHP、Java 或 Python 文件），并且还配置为以代码形式执行它们。这使得在服务器上创建自己的 Web Shell 变得轻而易举。

#### Web Shell

Web Shell 是一种恶意脚本，攻击者只需向正确的端点发送 HTTP 请求即可在远程 Web 服务器上执行任意命令。

如果您能够成功上传 Web Shell，那么您实际上就完全控制了服务器。这意味着您可以读取和写入任意文件、泄露敏感数据，甚至可以使用该服务器对内部基础设施和网络外部的其他服务器进行攻击。例如，以下 PHP 单行代码可用于从服务器的文件系统读取任意文件：

```
<?php echo file_get_contents('/path/to/target/file'); ?>
```

一旦上传，发送该恶意文件的请求将在响应中返回目标文件的内容。

一个更加通用的 Web Shell 可能看起来像这样：

```
<?php echo system($_GET['command']); ?>
```

该脚本使您能够通过查询参数传递任意系统命令，如下所示：

```
GET /example/exploit.php?command=id HTTP/1.1
```
